#!/usr/bin/env python3
"""
clip-image - Save clipboard image to file (cross-platform).
Designed for LLM coding assistants to access user clipboard images.
"""

import sys
import os
import subprocess
import tempfile
import platform

HELP_TEXT = """clip-image - Save clipboard image to file

USAGE:
    clip-image [OUTPUT_PATH]

ARGUMENTS:
    OUTPUT_PATH    Path to save image (default: {default_path})

EXAMPLES:
    clip-image                     # Save to temp directory
    clip-image ~/screenshot.png    # Save to specific path

FOR LLM ASSISTANTS:
    Run: clip-image
    Then read the image file at the printed path to see what the user copied.
"""

def get_default_path():
    return os.path.join(tempfile.gettempdir(), "clipboard-image.png")

def show_help():
    print(HELP_TEXT.format(default_path=get_default_path()))

def get_clipboard_image_macos(output_path):
    """macOS: use osascript."""
    script = f'''
    set theFile to POSIX file "{output_path}"
    try
        set imageData to the clipboard as «class PNGf»
        set fileRef to open for access theFile with write permission
        set eof fileRef to 0
        write imageData to fileRef
        close access fileRef
        return "saved"
    on error
        try
            close access theFile
        end try
        return "no image"
    end try
    '''
    result = subprocess.run(['osascript', '-e', script], capture_output=True, text=True)
    return result.stdout.strip() == "saved"

def get_clipboard_image_windows(output_path):
    """Windows: use PowerShell."""
    script = f'''
    Add-Type -AssemblyName System.Windows.Forms
    $img = [System.Windows.Forms.Clipboard]::GetImage()
    if ($img -ne $null) {{
        $img.Save("{output_path}")
        Write-Output "saved"
    }} else {{
        Write-Output "no image"
    }}
    '''
    result = subprocess.run(['powershell', '-Command', script], capture_output=True, text=True)
    return "saved" in result.stdout

def get_clipboard_image_linux(output_path):
    """Linux: use xclip."""
    try:
        result = subprocess.run(
            ['xclip', '-selection', 'clipboard', '-t', 'image/png', '-o'],
            capture_output=True
        )
        if result.returncode == 0 and result.stdout:
            with open(output_path, 'wb') as f:
                f.write(result.stdout)
            return True
    except FileNotFoundError:
        print("xclip not found. Install with: sudo apt install xclip")
    return False

def get_clipboard_image(output_path=None):
    if output_path is None:
        output_path = get_default_path()

    system = platform.system()

    if system == "Darwin":
        success = get_clipboard_image_macos(output_path)
    elif system == "Windows":
        success = get_clipboard_image_windows(output_path)
    elif system == "Linux":
        success = get_clipboard_image_linux(output_path)
    else:
        print(f"Unsupported platform: {system}")
        return False

    if success:
        print(f"Image saved to: {output_path}")
    else:
        print("No image in clipboard. Ask user to copy an image first (screenshot, etc.)")
    return success

if __name__ == "__main__":
    if len(sys.argv) > 1 and sys.argv[1] in ("-h", "--help"):
        show_help()
    else:
        output = sys.argv[1] if len(sys.argv) > 1 else None
        get_clipboard_image(output)
